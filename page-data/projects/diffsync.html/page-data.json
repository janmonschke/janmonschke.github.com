{"componentChunkName":"component---src-templates-blog-post-js","path":"/projects/diffsync.html","result":{"data":{"site":{"siteMetadata":{"title":"Jan Monschke","author":"Jan Monschke"}},"markdownRemark":{"id":"2d11a5a5-a330-5bf2-a553-9c5a14715c43","excerpt":"Table of contents Installation Demo How does it work? Usage Client Server DataAdapter Best Practices Algorithm Socket.io independence Enables real-time…","html":"<h2>Table of contents</h2>\n<ul>\n<li><a href=\"#installation\">Installation</a></li>\n<li><a href=\"#demo\">Demo</a></li>\n<li><a href=\"#how-does-it-work\">How does it work?</a></li>\n<li><a href=\"#usage\">Usage</a>\n<ul>\n<li><a href=\"#client\">Client</a></li>\n<li><a href=\"#server\">Server</a></li>\n<li><a href=\"#dataadapter\">DataAdapter</a></li>\n</ul>\n</li>\n<li><a href=\"#best-practices\">Best Practices</a></li>\n<li><a href=\"#algorithm\">Algorithm</a></li>\n<li><a href=\"#socketio-independence\">Socket.io independence</a></li>\n</ul>\n<p>Enables real-time collaborative editing of arbitrary JSON objects using the differential synchronization algorithm</p>\n<h2>Installation <a name=\"installation\"></a></h2>\n<p>diffsync is available via NPM for server and client (browserify &#x26; webpack):</p>\n<p><code class=\"language-text\">npm install diffsync</code></p>\n<p>If you are neither using browserify nor webpack for your client side code, you can get the latest version here:</p>\n<p><a href=\"https://wzrd.in/standalone/diffsync\">https://wzrd.in/standalone/diffsync</a></p>\n<p>For specific versions of the standalone version, simply add them to the URL like this:</p>\n<p><a href=\"https://wzrd.in/standalone/diffsync@1.0.2\">https://wzrd.in/standalone/diffsync@1.0.2</a></p>\n<h2>Demo <a name=\"demo\"></a></h2>\n<p><a href=\"https://diffsync-todos.herokuapp.com\">DiffSync-Todos</a>: An example implementation of a collaborative todo list hosted on heroku. (Source code: <a href=\"https://github.com/janmonschke/diffsync-todos\">https://github.com/janmonschke/diffsync-todos</a>) Try it out with a couple of browser windows open for the same list :)</p>\n<h2>How does it work? <a name=\"how-does-it-work\"></a></h2>\n<ul>\n<li>The client fetches the initial state of the data and enters a sync-room via WebSockets</li>\n<li>Every change of this state is synced via the <code class=\"language-text\">sync</code> method</li>\n<li>Clients receive events about changes from the server which are automatically applied to a shared object (in-place)</li>\n<li>The server takes care of syncing the state of all connected clients</li>\n<li>It uses a simple DataAdapter interface to fetch and store data with any kind of database</li>\n<li>Client and Server are syncing with the <a href=\"#algorithm\">Differential Synchronization</a> algorithm</li>\n</ul>\n<h2>Usage <a name=\"usage\"></a></h2>\n<p>diffsync consists of a client and a server component which both implement their side of the <a href=\"#algorithm\">Differential Synchronization Algorithm</a>. These two components communicate via a custom protocol that was built on top of socket.io. However, socket.io is no hard dependency and it can be replaced by whatever communication library you wish, as long as it implements the socket.io interface.</p>\n<p>The following paragraphs will show you how to get started. If you want to jump right into the code of a full example, head to <a href=\"https://github.com/janmonschke/diffsync-todos\">diffsync-todos</a>.</p>\n<h3>Client <a name=\"client\"></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// if installed from standalone script or browserify / webpack</span>\n<span class=\"token keyword\">var</span> DiffSyncClient <span class=\"token operator\">=</span> diffsync<span class=\"token punctuation\">.</span>Client <span class=\"token operator\">||</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'diffsync'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Client<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// socket.io standalone or browserify / webpack</span>\n<span class=\"token keyword\">var</span> socket <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span>io <span class=\"token operator\">||</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'socket.io-client'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// pass the connection and the id of the data you want to synchronize</span>\n<span class=\"token keyword\">var</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DiffSyncClient</span><span class=\"token punctuation\">(</span><span class=\"token function\">socket</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> data<span class=\"token punctuation\">;</span>\n\nclient<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connected'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// the initial data has been loaded,</span>\n  <span class=\"token comment\">// you can initialize your application</span>\n  data <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nclient<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'synced'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// an update from the server has been applied</span>\n  <span class=\"token comment\">// you can perform the updates in your application now</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nclient<span class=\"token punctuation\">.</span><span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">_ --- somewhere in your code --- _</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">;</span>\n\ndata<span class=\"token punctuation\">.</span>randomChange <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// schedule a sync cycle - this will sync your changes to the server</span>\nclient<span class=\"token punctuation\">.</span><span class=\"token function\">sync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The client is initialized by passing an instance of a socket.io connection (or a socket.io-compatible client) and the id of the object that should be synchronized with the server and other clients. The <code class=\"language-text\">initialize</code> method starts the synchronization.</p>\n<p>The client object notifies the application about the sync-state via a couple of events:</p>\n<ul>\n<li><code class=\"language-text\">connected</code>: The client is connected to the server and the initial data has been loaded.</li>\n<li><code class=\"language-text\">synced</code>: A new version from the server has been applied to the local data, you can update views now</li>\n<li><code class=\"language-text\">error</code>: There was an error during synchronization.</li>\n</ul>\n<p>The data object that is being synced, can be accessed via the clients <code class=\"language-text\">getData</code> method. It can’t be accessed before the <code class=\"language-text\">connected</code> event has been fired.</p>\n<p>It is important that your application is altering the exact same object that is returned by <code class=\"language-text\">getData</code> because the algorithm synchronizes based on changesets of this object. Every update from the server is also applied to this very object and is notified by the <code class=\"language-text\">synced</code> event.</p>\n<p>When your application has changed the state of this object, the <code class=\"language-text\">sync</code> method of the client needs to be called to trigger a sync with the server and other connected clients. Since the algorithm is based on sending diffs around, it is perfectly okay to call the <code class=\"language-text\">sync</code> method after every update on the data.</p>\n<p>The <a href=\"https://github.com/janmonschke/diffsync-todos\">diffsync-todos app</a> provides an example client-side integration of diffsync into a todo list application. Check it out to find out how to integrate it into your existing application. In a nutshell, it makes use of <code class=\"language-text\">Object.observe</code> (and a polyfill for it) to track changes from within the app that are then synced to the server.</p>\n<h3>Server <a name=\"server\"></a></h3>\n<p>Setting up the server in a very minimal way (with express):</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// setting up express and socket.io</span>\n<span class=\"token keyword\">var</span> app <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> http <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Server</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> io <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'socket.io'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>http<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// setting up diffsync's DataAdapter</span>\n<span class=\"token keyword\">var</span> diffsync <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'diffsync'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> dataAdapter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">diffSync<span class=\"token punctuation\">.</span>InMemoryDataAdapter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// setting up the diffsync server</span>\n<span class=\"token keyword\">var</span> diffSyncServer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DiffSync<span class=\"token punctuation\">.</span>Server</span><span class=\"token punctuation\">(</span>dataAdapter<span class=\"token punctuation\">,</span> io<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// starting the http server</span>\nhttp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">4000</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ready to go'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This is all that is needed for running the server part. There is no further addition necessary. Most of the logic is happening in the <code class=\"language-text\">DataAdapter</code>, which is described in the next section.</p>\n<h3>DataAdapter <a name=\"dataadapter\"></a></h3>\n<p>A <code class=\"language-text\">DataAdapter</code> is used by the server component internally to fetch data to initialize the synchronization and to save the data periodically. The simple interface allows to write a custom data provider for which ever data source you are using in your web app.</p>\n<p>The interface consists of two methods:</p>\n<ul>\n<li><code class=\"language-text\">getData(id callback)</code>:\n<ul>\n<li>is called for the initialization of the algorithm</li>\n<li><code class=\"language-text\">id (String / Number)</code> is the id of the data</li>\n<li><code class=\"language-text\">callback (Function[err, data])</code> the callback that should be called after fetching the data. Normal node.js style with the first parameter being the error and the second parameter being the data</li>\n</ul>\n</li>\n<li><code class=\"language-text\">storeData(id, data, callback)</code>:\n<ul>\n<li>is called to persist data periodically</li>\n<li><code class=\"language-text\">id (String / Number)</code> is the id of the data</li>\n<li><code class=\"language-text\">data (Object)</code> the new version of the data that will be saved</li>\n<li><code class=\"language-text\">callback (Function[err])</code> call back with an error if saving failed</li>\n</ul>\n</li>\n</ul>\n<p>diffsync ships with a simple in-memory DataAdapter which is used in the above example. It is, however, not recommended to use it in a production app since it does not persist data.</p>\n<h2>Best Practices <a name=\"best-practices\"></a></h2>\n<ul>\n<li>If you have arrays of objects in your data structure, it is highly recommended, that these objects have either an <code class=\"language-text\">id</code> or an <code class=\"language-text\">_id</code> field which can will be used by the diff-algorithm to identify moved objects in an array</li>\n<li>Error events are the result of a problem in the sync cycle and there is currently no failback procedure implemented yet (see <a href=\"#algorithm\">Algorithm</a>). The best way to restore sync is to reload the client’s page. Since only very small diffs are sent around, the data loss should be minimal. This might sound pretty horrible at first, but in reality, sync problems almost never occur unless one of the sides has lost the connection for a substantial amount of time.</li>\n</ul>\n<h2>Algorithm <a name=\"algorithm\"></a></h2>\n<p>The Differential Synchronization algorithm was invented by Neil Fraser in 2009. He wrote a paper about that can be found here: <a href=\"https://neil.fraser.name/writing/sync/\">https://neil.fraser.name/writing/sync/</a>. In addition to that, he held a Google Tech Talk about it, which is available on YouTube: <a href=\"https://www.youtube.com/watch?v=S2Hp_1jqpY8\">https://www.youtube.com/watch?v=S2Hp_1jqpY8</a>.</p>\n<h2>Socket.io independence <a name=\"socketio-independence\"></a></h2>\n<p>Neither client, nor server ship with a dependency of socket.io. This allows to replace the transportation layer with a completely different library which is compatible to the socket.io interface. This implementation relies on named-events, acknowledgments, rooms and it does not make any assumption about the underlying transportation protocol.</p>","frontmatter":{"title":"diffsync - real-time collaborative editing using the differntial synchronization algorithm","type":"project","date":null,"pomodoros":null,"keywords":null,"image":null}},"webmentions":{"edges":[]},"likes":{"edges":[]}},"pageContext":{"slug":"/projects/diffsync.html","publicUrl":"https://janmonschke.com/projects/diffsync.html"}},"staticQueryHashes":["1677560032","3729604799"]}